# バックエンドAPI設計 決定事項

## 1. 営業時間・定休日設定

### 【決定が必要】営業時間の管理方法
**推奨案：**
- デフォルト営業時間をシステム設定として保持
- スタッフ個別のシフト登録で上書き可能
- 定休日は営業カレンダーテーブルで管理

```json
// システム設定例
{
  "default_business_hours": {
    "monday": {"start": "09:00", "end": "19:00"},
    "tuesday": {"start": "09:00", "end": "19:00"},
    "wednesday": {"closed": true},
    "thursday": {"start": "09:00", "end": "19:00"},
    "friday": {"start": "09:00", "end": "19:00"},
    "saturday": {"start": "09:00", "end": "18:00"},
    "sunday": {"start": "10:00", "end": "17:00"}
  }
}
```

**検討事項：**
- [ ] 営業時間の変更頻度はどの程度か？
- [ ] 祝日対応が必要か？
- [ ] 特別営業日（年末年始等）の設定が必要か？

---

## 2. 予約フロー詳細仕様

### 【決定が必要】予約可能期間
**推奨案：**
- 最短：翌日から（当日予約不可）
- 最長：90日後まで
- システム設定で変更可能

### 【決定が必要】予約ステータス遷移
**推奨案：**
```
pending → confirmed → in_progress → completed
     ↓
  cancelled
```

- `pending`: 仮予約（自動確定するまで30分間保持）
- `confirmed`: 確定予約
- `in_progress`: 施術中
- `completed`: 完了
- `cancelled`: キャンセル

### 【決定が必要】キャンセル・変更ルール
**推奨案：**
- キャンセル：2時間前まで無料
- 変更：1時間前まで可能
- 当日キャンセル：キャンセル料発生（将来実装）

**検討事項：**
- [ ] 仮予約の保持時間は適切か？
- [ ] キャンセル・変更の制限時間は適切か？
- [ ] 同一顧客の連続予約を制限するか？

---

## 3. 空き時間検索アルゴリズム

### 【決定が必要】検索条件の優先順位
**推奨案：**
1. メニューに対応するラベルを持つスタッフを抽出
2. 指定日にシフトが登録されているスタッフを抽出
3. 必要時間が確保できる空き枠を検索
4. 予約間隔（15分）を考慮して結果を返す

### 【決定が必要】予約間隔の設定
**推奨案：**
- 予約と予約の間に15分の間隔を設ける
- システム設定で変更可能

### 【決定が必要】検索結果の表示形式
**推奨案：**
```json
{
  "available_slots": [
    {
      "staff_id": "uuid",
      "staff_name": "田中",
      "available_times": [
        {
          "start_time": "2025-06-30T10:00:00+09:00",
          "end_time": "2025-06-30T11:30:00+09:00"
        }
      ]
    }
  ]
}
```

**検討事項：**
- [ ] 予約間隔15分は適切か？
- [ ] 複数スタッフが対応可能な場合の表示順序は？
- [ ] 人気スタッフの優先表示が必要か？

---

## 4. 通知システム仕様

### 【決定が必要】通知タイミング
**推奨案：**
- 予約確定時：即座
- リマインダー：24時間前、2時間前
- キャンセル・変更時：即座

### 【決定が必要】通知チャネル
**推奨案：**
- メール：必須
- SMS：オプション（将来実装）
- プッシュ通知：オプション（将来実装）

### 【決定が必要】通知内容テンプレート
**推奨案：**
```
【予約確定】
田中様、以下の予約が確定しました。
日時：2025年6月30日 10:00-11:30
スタッフ：佐藤
メニュー：カット + カラー
料金：8,000円
```

### 【決定が必要】通知失敗時の対応
**推奨案：**
- 3回まで自動リトライ
- 管理画面で失敗通知を確認可能
- 手動再送機能

**検討事項：**
- [ ] 通知タイミングは適切か？
- [ ] 通知内容に追加すべき情報は？
- [ ] リトライ回数と間隔は適切か？

---

## 5. 認証・認可方式

### 【決定が必要】顧客認証方式
**推奨案：**
- 電話番号 + SMS認証
- 簡易的なパスワード設定（オプション）
- JWTトークンでセッション管理

### 【決定が必要】管理者認証方式
**推奨案：**
- メールアドレス + パスワード
- JWTトークンでセッション管理
- ロール管理（admin, staff）

### 【決定が必要】API認証方式
**推奨案：**
```
Authorization: Bearer <JWT_TOKEN>
```

**検討事項：**
- [ ] SMS認証の実装コストは許容範囲か？
- [ ] パスワードなしの認証で十分か？
- [ ] 管理者の役割分担は必要か？

---

## 6. エラーハンドリング

### 【決定が必要】エラーレスポンス形式
**推奨案：**
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力データに誤りがあります",
    "details": [
      {
        "field": "phone",
        "message": "電話番号の形式が正しくありません"
      }
    ]
  }
}
```

### 【決定が必要】エラーコード体系
**推奨案：**
- `VALIDATION_ERROR`: バリデーションエラー
- `NOT_FOUND`: リソースが見つからない
- `CONFLICT`: 重複エラー（予約時間重複等）
- `BUSINESS_RULE_ERROR`: ビジネスルール違反
- `INTERNAL_ERROR`: システム内部エラー

**検討事項：**
- [ ] エラーメッセージの日本語化は必要か？
- [ ] より詳細なエラーコードが必要か？

---

## 7. パフォーマンス・運用

### 【決定が必要】ページネーション
**推奨案：**
```
GET /api/v1/reservations?page=1&limit=20
```

### 【決定が必要】検索・フィルタリング
**推奨案：**
```
GET /api/v1/reservations?staff_id=uuid&status=confirmed&date_from=2025-06-30&date_to=2025-07-07
```

### 【決定が必要】レスポンス時間目標
**推奨案：**
- 一覧取得：200ms以下
- 空き時間検索：500ms以下
- 予約作成：300ms以下

**検討事項：**
- [ ] データ量増加時のパフォーマンス対策は？
- [ ] キャッシュ戦略は必要か？

---

## 8. その他の決定事項

### 【決定が必要】タイムゾーン処理
**推奨案：**
- データベース：UTC保存
- API：JST（+09:00）で送受信
- フロントエンド：ブラウザのタイムゾーンで表示

### 【決定が必要】ログ出力レベル
**推奨案：**
- 本番環境：INFO以上
- 開発環境：DEBUG以上
- 予約操作は必ずINFO以上でログ出力

### 【決定が必要】データベース接続設定
**推奨案：**
```
Max Open Connections: 25
Max Idle Connections: 10
Connection Max Lifetime: 1hour
```

**検討事項：**
- [ ] 想定同時接続数に対して適切か？
- [ ] 本番環境での監視項目は？

---

## レビュー・追記エリア

### 追加要件
<!-- ここに追加要件を記載してください -->

### 変更・修正事項
<!-- ここに変更・修正したい内容を記載してください -->

### 質問・確認事項
<!-- ここに質問や確認したい内容を記載してください -->

---

## 変更履歴

| 日付 | 変更者 | 変更内容 |
|------|--------|----------|
| 2025-06-29 | Claude | 初版作成 |